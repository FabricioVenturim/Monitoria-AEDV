---
title: "AED Limpeza e Tratamento de Dados - Aula 2"
author: "Fabr√≠cio Venturim"
date: "2023-04-25"
output: 
  html_document:
    number_sections: yes
    highlight: tango
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
      smmoth_scroll: no
    css: styles.css
  pdf_document:
    toc: yes
---




```{r}
if(!require(utf8)) install.packages("utf8") 

library(utf8)
Sys.setlocale("LC_ALL", "pt_br.utf-8") 
```

A limpeza de dados √© uma parte fundamental da ci√™ncia de dados, **mas pode ser profundamente frustrante**. Por que alguns de seus campos de texto est√£o ileg√≠veis? O que voc√™ deve fazer sobre esses valores ausentes? Por que suas datas n√£o est√£o formatadas corretamente? Como voc√™ pode limpar rapidamente a entrada de dados inconsistentes? Nesta aula, voc√™ aprender√° por que se deparou com esses problemas e, mais importante, como corrigi-los!

Nesta aula, voc√™ aprender√° como lidar com alguns dos problemas mais comuns de limpeza de dados para que possa realmente analisar seus dados mais rapidamente.
![](img/1.png)

![](img/2.png)


# Manipulando valores ausentes

## D√™ uma primeira olhada nos dados

A primeira coisa que precisamos fazer √© carregar as bibliotecas e o conjunto de dados que usaremos.

Para demonstra√ß√£o, usaremos um conjunto de dados de eventos ocorridos em jogos de futebol americano.

```{r}
if(!require(tidyverse)) install.packages("tidyverse")
#if(!require(dplyr)) install.packages("dplyr")
```

```{r}
library(tidyverse)
#library(dplyr)
```


```{r}
nfl_data <- read.csv("data/NFL.csv")
```

A primeira coisa a fazer quando voc√™ obt√©m um novo conjunto de dados √© dar uma olhada em alguns deles. Isso permite que voc√™ veja se tudo foi lido corretamente e d√° uma ideia do que est√° acontecendo com os dados. Nesse caso, vamos ver se h√° algum valor ausente, que ser√° representado por `NaN` ou `None`.

```{r}
head(nfl_data)
```

```{r}
str(nfl_data)
```

## Quantos dados ausentes temos?

Ok, agora sabemos que temos alguns valores ausentes. Vamos ver quantos temos em cada coluna.

```{r}
#is.na(nfl_data)
quant_dados_faltantes <- colSums(is.na(nfl_data))
quant_dados_faltantes
```
Isso parece muito! Pode ser √∫til ver qual porcentagem dos valores em nosso conjunto de dados estava faltando para nos dar uma no√ß√£o melhor da escala desse problema:

```{r}
porcentagem_dados_faltantes <- quant_dados_faltantes / nrow(nfl_data) * 100
porcentagem_dados_faltantes
```

Uau, quase um quarto das c√©lulas neste conjunto de dados est√° vazio! Na pr√≥xima etapa, examinaremos mais de perto algumas das colunas com valores ausentes e tentaremos descobrir o que pode estar acontecendo com elas.

## Descubra por que os dados est√£o faltando

Este √© o ponto em que entramos na parte da ci√™ncia de dados que gosto de chamar de **"data intution"**, ou seja, "realmente olhando para seus dados e tentando descobrir por que s√£o do jeito que s√£o e como isso vai afetar sua an√°lise". 

Pode ser uma parte frustrante da ci√™ncia de dados, especialmente se voc√™ for mais novo na √°rea e n√£o tiver muita experi√™ncia. Para lidar com valores ausentes, voc√™ precisar√° usar sua intui√ß√£o para descobrir por que o valor est√° ausente. Uma das perguntas mais importantes que voc√™ pode fazer a si mesmo para ajudar a descobrir isso √©:

> Este valor est√° faltando porque n√£o foi registrado ou porque n√£o existe?

* Se um valor est√° faltando porque n√£o existe (como a altura do filho mais velho de algu√©m que n√£o tem filhos), ent√£o n√£o faz sentido tentar adivinhar o que pode ser. **Esses valores voc√™ provavelmente deseja manter como NaN**. 

* Por outro lado, se um valor estiver faltando porque n√£o foi registrado, voc√™ pode tentar adivinhar o que poderia ter sido com base nos outros valores nessa coluna e linha, procurar a proced√™ncia daquele dado ou deletar.

Vamos trabalhar com um exemplo. Observando o n√∫mero de valores ausentes no dataframe `nfl_data`, noto que a coluna "TimesSec" possui muitos valores ausentes:

```{r}
quant_dados_faltantes["TimeSecs"]
```
Observando a [documenta√ß√£o](https://www.kaggle.com/datasets/maxhorowitz/nflplaybyplay2009to2016), vejo que esta coluna cont√©m informa√ß√µes sobre o n√∫mero de segundos restantes no jogo quando a jogada foi feita. Isso significa que esses valores provavelmente est√£o ausentes porque n√£o foram registrados, e n√£o porque n√£o existem. Portanto, faria sentido tentarmos adivinhar quais deveriam ser, em vez de apenas deix√°-los como NA.

```{r}
quant_dados_faltantes["PenalizedTeam"]
```


Por outro lado, existem outros campos, como "PenalizedTeam" que tamb√©m possuem muitos campos ausentes. Nesse caso, por√©m, falta o campo porque se n√£o houve p√™nalti n√£o faz sentido dizer qual time foi penalizado. Para esta coluna, faria mais sentido deix√°-la vazia ou adicionar um terceiro valor como "nenhum" e us√°-lo para substituir os NAs.

> Dica: este √© um √≥timo lugar para ler a documenta√ß√£o do conjunto de dados, caso ainda n√£o o tenha feito! Se voc√™ estiver trabalhando com um conjunto de dados que obteve de outra pessoa, tamb√©m pode tentar contat√°-la para obter mais informa√ß√µes.

Se voc√™ estiver fazendo uma an√°lise de dados muito cuidadosa, este √© o ponto em que voc√™ examinaria cada coluna individualmente para descobrir a melhor estrat√©gia para preencher os valores ausentes. No restante deste notebook, abordaremos algumas t√©cnicas "r√°pidas e sujas" que podem ajud√°-lo com valores ausentes, mas provavelmente tamb√©m acabar√£o removendo algumas informa√ß√µes √∫teis ou adicionando algum ru√≠do aos seus dados.

### Eliminar valores ausentes

Se voc√™ estiver com pressa ou n√£o tiver um motivo para descobrir por que seus valores est√£o ausentes, uma op√ß√£o √© simplesmente remover quaisquer linhas ou colunas que contenham valores ausentes. (**Observa√ß√£o: geralmente n√£o recomendo esta abordagem para projetos importantes! Geralmente vale a pena dedicar um tempo para examinar seus dados e realmente examinar todas as colunas com valores ausentes, uma a uma, para realmente conhecer seu conjunto de dados.**)

```{r}
nfl_data_na <- na.omit(nfl_data)
```

```{r}
nfl_data_na
```

Nossa, parece que removemos todos os nossos dados! üò± Isso ocorre porque cada linha em nosso conjunto de dados tinha pelo menos um valor ausente. Podemos ter mais sorte removendo todas as colunas que t√™m pelo menos um valor ausente.

```{r}
data_sem_col_na <- select_if(nfl_data, ~ !any(is.na(.)))
```

A fun√ß√£o `%>%` √© usada para encadear as opera√ß√µes do `dplyr`. A fun√ß√£o `select_if()` √© usada para selecionar colunas de "nfl_data" de acordo com uma condi√ß√£o. A condi√ß√£o neste caso √© uma fun√ß√£o an√¥nima `~ !any(is.na(.))`, que √© aplicada a cada coluna. A fun√ß√£o `~` √© uma nota√ß√£o usada pelo dplyr para definir fun√ß√µes an√¥nimas.

A fun√ß√£o `is.na()` √© usada para verificar se h√° valores ausentes em cada coluna, e a fun√ß√£o `any()` √© usada para verificar se pelo menos um valor √© ausente. O operador `!` √© usado para negar a condi√ß√£o, ou seja, selecionar apenas colunas que n√£o contenham valores ausentes.

Em resumo, este c√≥digo seleciona todas as colunas de "nfl_data" que n√£o cont√™m valores ausentes e armazena os dados resultantes na nova vari√°vel "columns_with_na_dropped".

```{r}
head(data_sem_col_na)
```
n√∫mero de colunas no dataframe original:

```{r}
print(ncol(nfl_data))
```

N√∫mero de colunas agora:

```{r}
print(ncol(data_sem_col_na))
```


Perdemos muitos dados, mas neste ponto removemos com sucesso todos os NaNs de nossos dados.

### Preencher valores ausentes automaticamente

outra op√ß√£o √© tentar preencher os valores ausentes. Para a pr√≥xima parte, estou obtendo uma pequena subse√ß√£o dos dados da NFL para que sejam bem impressos.

```{r}
subset_nfl_data <- head(select(nfl_data, EPA:Season))
head(subset_nfl_data)
```

Podemos usar a fun√ß√£o `replace(is.na(.), 0)` do pacote tidyr no R para preencher os valores ausentes em um data frame. Uma op√ß√£o √© especificar com o que queremos substituir os valores ausentes. Aqui, estamos dizendo que gostar√≠amos de substituir todos os valores ausentes por 0:

```{r}
nfl_data_filled <- subset_nfl_data %>% 
  replace(is.na(.), 0)
```

```{r}
head(nfl_data_filled)
```

Podemos preencher com a m√©dia da coluna:

```{r}
nfl_data_na_mean <- subset_nfl_data %>% 
  mutate_all(~ifelse(is.na(.), mean(., na.rm = TRUE), .))
```

```{r}
head(nfl_data_na_mean)
```


Eu tamb√©m poderia ser um pouco mais experiente e substituir os valores ausentes por qualquer valor que vier diretamente antes dele na mesma coluna. (Isso faz muito sentido para conjuntos de dados em que as observa√ß√µes t√™m algum tipo de ordem l√≥gica.)

```{r}
nfl_data_filled <- subset_nfl_data %>%
  fill(everything(), .direction = "down") %>%
  replace(is.na(.), 0)
```

```{r}
head(nfl_data_filled)
```


Existem t√©cnicas avan√ßadas que s√£o combinadas com o preenchimento de valores, como, por exemplo, analisar correla√ß√µes ou mesmo construir um modelo preditivo para missing values.

Entretanto, uma abordagem direta e simples consiste em substituir os NaN pela mediana da coluna. Isso √© feito mediante o m√©todo df.fillna(), informando o valor desejado como argumento.


# Valores Extremos

```{r}
library(ggplot2)
```

```{r}
# Cria um gr√°fico de exemplo
ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  labs(title = "Gr√°fico de exemplo")
```

```{r}
if(!require(extrafont)) install.packages("extrafont")
library(extrafont)
font_import()
loadfonts(device = "win")
```


```{r}
# Altera a fonte para Arial
ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  labs(title = "Gr√°fico de exemplo") +
  theme(text=element_text(size=16,  family="Comic Sans MS"))
```





